import { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import {
  FileText,
  Printer,
  Send,
  Search,
  Calendar,
  User,
  CreditCard,
  Plus,
  Wrench,
  ShoppingCart,
  Trash2,
  AlertTriangle,
  CheckCircle,
  Clock,
  DollarSign,
  TrendingUp,
  TrendingDown,
  Eye,
  EyeOff,
  RefreshCw,
  Filter,
  SortAsc,
  SortDesc,
  Zap,
  Info,
  Lightbulb,
  Star,
  Shield,
  Activity,
  Bell,
  Download,
  Upload,
  Save,
  Copy,
  Share2,
  Archive,
  Target,
  BarChart3,
  PieChart,
  LineChart,
  Receipt,
  Building,
  Smartphone,
  Repeat,
  AlertCircle,
  CheckSquare,
  Square,
  Mail,
  MessageSquare,
  Phone,
  MapPin,
  Tag,
  Settings,
  X,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { formatCurrency } from "@/lib/currency";
import { format, parseISO } from "date-fns";
import LogoDisplay from "@/components/logo-display";
import { Skeleton } from "@/components/ui/skeleton";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Switch } from "@/components/ui/switch";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { useAuth } from "@/hooks/useAuth";
interface LoanInvoice {
  id: string;
  customerId: string;
  customerName: string;
  customerEmail: string;
  customerPhone: string;
  deviceDescription: string;
  serviceDescription: string;
  totalAmount: number | string;
  paidAmount: number | string;
  remainingAmount: number | string;
  dueDate: string;
  status: "pending" | "overdue" | "paid" | "cancelled";
  notes?: string;
  createdAt: string;
}
interface OutstandingAmount {
  id: string;
  type: "service" | "sales";
  description: string;
  amount: number | string;
  unitPrice?: number | string;
  quantity?: number;
  date: string;
  customerId: string;
  customerName: string;
  selected: boolean;
  itemName?: string;
  itemDescription?: string;
}
export default function LoanInvoices() {
  const { toast } = useToast();
  const { user } = useAuth();
  const queryClient = useQueryClient();
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [isPaymentDialogOpen, setIsPaymentDialogOpen] = useState(false);
  const [isCombinedInvoiceDialogOpen, setIsCombinedInvoiceDialogOpen] =
    useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [statusFilter, setStatusFilter] = useState("all");
  const [selectedInvoice, setSelectedInvoice] = useState<LoanInvoice | null>(
    null
  );
  const [selectedCustomer, setSelectedCustomer] = useState<string>("");
  const [editingInvoice, setEditingInvoice] = useState<LoanInvoice | null>(
    null
  );
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [paymentData, setPaymentData] = useState({
    amount: "",
    paymentMethod: "cash",
    notes: "",
  });

  // Enhanced state management
  const [viewMode, setViewMode] = useState<"list" | "grid" | "analytics">("list");
  const [sortBy, setSortBy] = useState<"date" | "amount" | "status" | "customer">("date");
  const [sortOrder, setSortOrder] = useState<"asc" | "desc">("desc");
  const [showInsights, setShowInsights] = useState(true);
  const [compactView, setCompactView] = useState(false);
  const [autoRefresh, setAutoRefresh] = useState(false);
  const [selectedInvoices, setSelectedInvoices] = useState<string[]>([]);
  const [bulkActions, setBulkActions] = useState(false);
  const [notifications, setNotifications] = useState<Array<{
    id: string;
    type: 'info' | 'warning' | 'success' | 'error';
    message: string;
    timestamp: Date;
  }>>([]);
  const [activeTab, setActiveTab] = useState("overview");
  const { data: invoices = [], isLoading } = useQuery<LoanInvoice[]>({
    queryKey: ["loan-invoices"],
  });
  const { data: customers = [], isLoading: customersLoading } = useQuery<any[]>(
    {
      queryKey: ["customers"],
    }
  );
  // Get outstanding service loans (devices with status 'delivered' but not fully paid)
  const { data: outstandingServices = [] } = useQuery<any[]>({
    queryKey: ["outstanding-services"],
    queryFn: async () => {
      return apiRequest("/api/devices/outstanding-services", "GET");
    },
  });
  // Get outstanding sales (sales with payment status 'pending' or partial)
  const { data: outstandingSales = [] } = useQuery<any[]>({
    queryKey: ["outstanding-sales"],
    queryFn: async () => {
      const data = await apiRequest("/api/sales/outstanding", "GET");
      return data;
    },
  });
  const [formData, setFormData] = useState({
    customerId: "",
    deviceDescription: "",
    serviceDescription: "",
    totalAmount: "",
    paidAmount: "0",
    dueDate: new Date().toISOString().split("T")[0],
    notes: "",
  });
  const [combinedInvoiceData, setCombinedInvoiceData] = useState({
    customerId: "",
    dueDate: new Date().toISOString().split("T")[0],
    notes: "",
    selectedItems: [] as OutstandingAmount[],
  });
  const createInvoiceMutation = useMutation({
    mutationFn: async (data: any) => {
      const invoiceData = {
        ...data,
        dueDate: new Date(data.dueDate).toISOString(),
        totalAmount: parseFloat(data.totalAmount),
        paidAmount: parseFloat(data.paidAmount),
      };
      const response = await apiRequest(
        "/api/loan-invoices",
        "POST",
        invoiceData
      );
      return response;
    },
    onSuccess: () => {
      toast({
        title: "Success",
        description: "Loan invoice created successfully",
      });
      queryClient.invalidateQueries({ queryKey: ["loan-invoices"] });
      setIsDialogOpen(false);
      setFormData({
        customerId: "",
        deviceDescription: "",
        serviceDescription: "",
        totalAmount: "",
        paidAmount: "0",
        dueDate: new Date().toISOString().split("T")[0],
        notes: "",
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to create loan invoice",
        variant: "destructive",
      });
    },
  });
  const createCombinedInvoiceMutation = useMutation({
    mutationFn: async (data: any) => {
      const response = await apiRequest(
        "/api/loan-invoices/combined",
        "POST",
        data
      );
      return response;
    },
    onSuccess: () => {
      toast({
        title: "Success",
        description: "Combined loan invoice created successfully",
      });
      queryClient.invalidateQueries({ queryKey: ["loan-invoices"] });
      queryClient.invalidateQueries({ queryKey: ["outstanding-services"] });
      queryClient.invalidateQueries({ queryKey: ["outstanding-sales"] });
      setIsCombinedInvoiceDialogOpen(false);
      setCombinedInvoiceData({
        customerId: "",
        dueDate: new Date().toISOString().split("T")[0],
        notes: "",
        selectedItems: [],
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to create combined loan invoice",
        variant: "destructive",
      });
    },
  });
  const recordPaymentMutation = useMutation({
    mutationFn: async (data: any) => {
      const response = await apiRequest(
        `/api/loan-invoices/${selectedInvoice?.id}/record-payment`,
        "POST",
        data
      );
      return response;
    },
    onSuccess: () => {
      toast({
        title: "Success",
        description: "Payment recorded successfully",
      });
      queryClient.invalidateQueries({ queryKey: ["loan-invoices"] });
      setIsPaymentDialogOpen(false);
      setPaymentData({
        amount: "",
        paymentMethod: "cash",
        notes: "",
      });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to record payment",
        variant: "destructive",
      });
    },
  });
  const updateInvoiceMutation = useMutation({
    mutationFn: async (data: { id: string; updates: any }) => {
      const response = await apiRequest(
        `/api/loan-invoices/${data.id}`,
        "PUT",
        data.updates
      );
      return response;
    },
    onSuccess: () => {
      toast({
        title: "Success",
        description: "Invoice updated successfully",
      });
      queryClient.invalidateQueries({ queryKey: ["loan-invoices"] });
      setIsEditDialogOpen(false);
      setEditingInvoice(null);
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to update invoice",
        variant: "destructive",
      });
    },
  });
  const deleteInvoiceMutation = useMutation({
    mutationFn: async (id: string) => {
      const response = await apiRequest(`/api/loan-invoices/${id}`, "DELETE");
      return response;
    },
    onSuccess: () => {
      toast({
        title: "Success",
        description: "Invoice deleted successfully",
      });
      queryClient.invalidateQueries({ queryKey: ["loan-invoices"] });
    },
    onError: () => {
      toast({
        title: "Error",
        description: "Failed to delete invoice",
        variant: "destructive",
      });
    },
  });
  // Get outstanding amounts for selected customer
  const getOutstandingAmounts = (customerId: string): OutstandingAmount[] => {
    console.log("All outstanding services:", outstandingServices);
    const services = outstandingServices
      .filter((service: any) => {
        console.log(
          "Service customerId:",
          service.customerId,
          "matches:",
          service.customerId === customerId
        );
        return service.customerId === customerId;
      })
      .map((service: any) => ({
        id: service.id,
        type: "service" as const,
        description: `${service.deviceType} - ${service.brand} ${service.model}`,
        amount: Number(service.totalCost || 0),
        date: service.updatedAt || service.createdAt,
        customerId: service.customerId,
        customerName: service.customerName,
        selected: false,
      }));
    const sales = outstandingSales
      .filter((sale: any) => {
        console.log(
          "Sale customerId:",
          sale.customerId,
          "matches:",
          sale.customerId === customerId
        );
        // Include sales that match the customer OR have no customerId (unassigned)
        return sale.customerId === customerId || !sale.customerId;
      })
      .flatMap((sale: any) => {
        console.log("Sale items:", sale.items);
        // If sale has items, create separate entries for each item
        if (sale.items && sale.items.length > 0) {
          return sale.items.map((item: any) => {
            const description =
              item.itemName ||
              item.itemDescription ||
              `Item #${item.id.slice(0, 8)}`;
            return {
              id: `${sale.id}-${item.id}`,
              type: "sales" as const,
              description: description,
              amount: Number(item.totalPrice || 0),
              unitPrice: Number(item.unitPrice || 0),
              quantity: Number(item.quantity || 1),
              date: sale.createdAt,
              customerId: sale.customerId || customerId,
              customerName: sale.customerName || "Unassigned",
              selected: false,
              itemName: item.itemName,
              itemDescription: item.itemDescription,
            };
          });
        } else {
          // Fallback for sales without items
          return [
            {
              id: sale.id,
              type: "sales" as const,
              description: sale.customerId
                ? `Sale #${sale.id.slice(0, 8)}`
                : `Unassigned Sale #${sale.id.slice(0, 8)}`,
              amount: Number(sale.totalAmount || 0),
              unitPrice: Number(sale.totalAmount || 0),
              quantity: 1,
              date: sale.createdAt,
              customerId: sale.customerId || customerId,
              customerName: sale.customerName || "Unassigned",
              selected: false,
            },
          ];
        }
      });
    const result = [...services, ...sales];
    return result;
  };
  const handleCustomerChange = (customerId: string) => {
    console.log("Outstanding services:", outstandingServices);
    setSelectedCustomer(customerId);
    const outstandingAmounts = getOutstandingAmounts(customerId);
    setCombinedInvoiceData((prev) => ({
      ...prev,
      customerId,
      selectedItems: outstandingAmounts,
    }));
  };
  const handleItemSelection = (itemId: string, selected: boolean) => {
    setCombinedInvoiceData((prev) => ({
      ...prev,
      selectedItems: prev.selectedItems.map((item) =>
        item.id === itemId ? { ...item, selected } : item
      ),
    }));
  };
  const handleCombinedInvoiceSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const selectedItems = combinedInvoiceData.selectedItems.filter(
      (item) => item.selected
    );
    if (selectedItems.length === 0) {
      toast({
        title: "Error",
        description: "Please select at least one item",
        variant: "destructive",
      });
      return;
    }
    const totalAmount = selectedItems.reduce(
      (sum, item) => sum + Number(item.amount),
      0
    );
    const itemsToStore = selectedItems.map((item) => ({
      id: item.id,
      type: item.type,
      description: item.description,
      amount: item.amount,
      unitPrice: item.unitPrice,
      quantity: item.quantity,
      // Store original item data for better description handling
      originalData: {
        itemName: item.itemName,
        itemDescription: item.itemDescription,
      },
    }));
    createCombinedInvoiceMutation.mutate({
      customerId: combinedInvoiceData.customerId,
      dueDate: new Date(combinedInvoiceData.dueDate).toISOString(),
      notes: combinedInvoiceData.notes,
      items: itemsToStore,
      totalAmount,
    });
  };
  // Enhanced helper functions
  const addNotification = (type: 'info' | 'warning' | 'success' | 'error', message: string) => {
    const notification = {
      id: Date.now().toString(),
      type,
      message,
      timestamp: new Date(),
    };
    
    setNotifications(prev => [...prev, notification].slice(-5)); // Keep last 5

    // Auto-remove after 5 seconds
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== notification.id));
    }, 5000);
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case "paid":
        return "bg-green-100 text-green-800 border-green-200";
      case "pending":
        return "bg-yellow-100 text-yellow-800 border-yellow-200";
      case "overdue":
        return "bg-red-100 text-red-800 border-red-200";
      case "cancelled":
        return "bg-gray-100 text-gray-800 border-gray-200";
      default:
        return "bg-gray-100 text-gray-800 border-gray-200";
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "paid":
        return <CheckCircle className="h-4 w-4" />;
      case "pending":
        return <Clock className="h-4 w-4" />;
      case "overdue":
        return <AlertTriangle className="h-4 w-4" />;
      case "cancelled":
        return <X className="h-4 w-4" />;
      default:
        return <Info className="h-4 w-4" />;
    }
  };

  const getPaymentMethodIcon = (method: string) => {
    switch (method) {
      case "cash":
        return <DollarSign className="h-3 w-3" />;
      case "bank-transfer":
        return <Building className="h-3 w-3" />;
      case "credit-card":
        return <CreditCard className="h-3 w-3" />;
      case "mobile-money":
        return <Smartphone className="h-3 w-3" />;
      default:
        return <Receipt className="h-3 w-3" />;
    }
  };

  const getInvoiceStatus = (invoice: LoanInvoice) => {
    const remaining = parseFloat(invoice.remainingAmount?.toString() || "0");
    const total = parseFloat(invoice.totalAmount?.toString() || "0");
    const dueDate = new Date(invoice.dueDate);
    const today = new Date();
    
    if (remaining === 0) return { status: "paid", color: "text-green-600", icon: <CheckCircle className="h-4 w-4" /> };
    if (dueDate < today) return { status: "overdue", color: "text-red-600", icon: <AlertTriangle className="h-4 w-4" /> };
    if (remaining < total) return { status: "partial", color: "text-yellow-600", icon: <Clock className="h-4 w-4" /> };
    return { status: "pending", color: "text-blue-600", icon: <Info className="h-4 w-4" /> };
  };

  const calculateInvoiceStats = () => {
    const totalInvoices = invoices.length;
    const totalAmount = invoices.reduce((sum, inv) => sum + parseFloat(inv.totalAmount?.toString() || "0"), 0);
    const totalPaid = invoices.reduce((sum, inv) => sum + parseFloat(inv.paidAmount?.toString() || "0"), 0);
    const totalRemaining = invoices.reduce((sum, inv) => sum + parseFloat(inv.remainingAmount?.toString() || "0"), 0);
    const overdueInvoices = invoices.filter(inv => {
      const dueDate = new Date(inv.dueDate);
      const today = new Date();
      return dueDate < today && parseFloat(inv.remainingAmount?.toString() || "0") > 0;
    });
    const paidInvoices = invoices.filter(inv => parseFloat(inv.remainingAmount?.toString() || "0") === 0);
    
    return {
      totalInvoices,
      totalAmount,
      totalPaid,
      totalRemaining,
      overdueInvoices: overdueInvoices.length,
      paidInvoices: paidInvoices.length,
      collectionRate: totalAmount > 0 ? (totalPaid / totalAmount) * 100 : 0
    };
  };

  const printInvoice = (invoice: LoanInvoice) => {
    // Debug logging to see what data we're getting
    console.log("Device description:", invoice.deviceDescription);
    console.log("Total amount:", invoice.totalAmount);
    // Ensure we have valid data with fallbacks
    const safeInvoice = {
      id: invoice.id || "N/A",
      customerName: invoice.customerName || "Unknown Customer",
      customerEmail: invoice.customerEmail || "N/A",
      customerPhone: invoice.customerPhone || "N/A",
      deviceDescription: invoice.deviceDescription || "No device description",
      serviceDescription:
        invoice.serviceDescription || "No service description",
      totalAmount: Number(invoice.totalAmount) || 0,
      paidAmount: Number(invoice.paidAmount) || 0,
      remainingAmount: Number(invoice.remainingAmount) || 0,
      dueDate: invoice.dueDate || new Date().toISOString(),
      createdAt: invoice.createdAt || new Date().toISOString(),
      status: invoice.status || "pending",
      notes: invoice.notes || "",
    };
    const printWindow = window.open("", "_blank");
    if (printWindow) {
      // Check if this is a combined invoice
      const isCombinedInvoice =
        safeInvoice.notes &&
        safeInvoice.notes.startsWith("COMBINED_INVOICE_ITEMS:");
      let items: any[] = [];
      if (isCombinedInvoice) {
        try {
          const itemsJson = safeInvoice.notes.replace(
            "COMBINED_INVOICE_ITEMS:",
            ""
          );
          items = JSON.parse(itemsJson);
          console.log(
            "Items with descriptions:",
            items.map((item: any) => ({
              id: item.id,
              description: item.description,
              originalData: item.originalData,
              itemName: item.itemName,
              itemDescription: item.itemDescription,
            }))
          );
        } catch (error) {}
      }
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Loan Invoice - ${safeInvoice.customerName}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .header { text-align: center; margin-bottom: 30px; }
            .invoice-details { margin-bottom: 20px; }
            .customer-info { margin-bottom: 20px; }
            .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .items-table th, .items-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .items-table th { background-color: #f2f2f2; }
            .total { font-weight: bold; font-size: 18px; }
            .payment-status { margin-top: 20px; }
            .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
            .item-type { font-size: 12px; color: #666; font-style: italic; }
          </style>
        </head>
        <body>
          <div class="header">
            <div style="text-align: center; margin-bottom: 10px;">
              <img id="company-logo" src="" alt="Company Logo" style="max-width: 100px; max-height: 50px; object-fit: contain;">
            </div>
            <h1>LOAN INVOICE</h1>
            <p>SolNet Computer Services</p>
          </div>
          
          <div class="invoice-details">
            <p><strong>Invoice Date:</strong> ${format(
              parseISO(safeInvoice.createdAt),
              "PPP"
            )}</p>
            <p><strong>Due Date:</strong> ${format(
              parseISO(safeInvoice.dueDate),
              "PPP"
            )}</p>
            <p><strong>Invoice #:</strong> ${safeInvoice.id.slice(0, 8)}</p>
          </div>
          <div class="customer-info">
            <h3>Customer Information</h3>
            <p><strong>Name:</strong> ${safeInvoice.customerName}</p>
            <p><strong>Email:</strong> ${safeInvoice.customerEmail}</p>
            <p><strong>Phone:</strong> ${safeInvoice.customerPhone}</p>
          </div>
          <table class="items-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Type</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
                              ${
                                isCombinedInvoice && items.length > 0
                                  ? items
                                      .map(
                                        (item: any) => `
                  <tr>
                    <td>${
                      item.description ||
                      (item.originalData?.itemName &&
                      item.originalData?.itemDescription
                        ? `${item.originalData.itemName} - ${item.originalData.itemDescription}`
                        : item.originalData?.itemName ||
                          item.originalData?.itemDescription ||
                          "N/A")
                    }</td>
                    <td class="item-type">${
                      item.type === "service" ? "Service" : "Sales"
                    }</td>
                    <td>${item.quantity || 1}</td>
                    <td>$${
                      Number(item.unitPrice) || Number(item.amount) || 0
                    }</td>
                        <td>{formatCurrency(item.amount)}</td>
              </tr>
                `
                                      )
                                      .join("")
                                  : `
                <tr>
                  <td>${safeInvoice.deviceDescription} - ${safeInvoice.serviceDescription}</td>
                  <td class="item-type">Service</td>
                  <td>1</td>
                                          <td>{formatCurrency(safeInvoice.totalAmount)}</td>
                        <td>{formatCurrency(safeInvoice.totalAmount)}</td>
              </tr>
              `
                              }
            </tbody>
          </table>
          <div class="total">
            <p><strong>Total Amount: $${safeInvoice.totalAmount.toFixed(
              2
            )}</strong></p>
            <p><strong>Paid Amount: $${safeInvoice.paidAmount.toFixed(
              2
            )}</strong></p>
            <p><strong>Remaining Balance: $${safeInvoice.remainingAmount.toFixed(
              2
            )}</strong></p>
          </div>
          <div class="payment-status">
            <p class="status-${
              safeInvoice.status
            }"><strong>Status: ${safeInvoice.status.toUpperCase()}</strong></p>
          </div>
          <div class="footer">
            <p>Thank you for choosing SolNet Computer Services!</p>
            <p>Please contact us if you have any questions about this invoice.</p>
          </div>
        </body>
        <script>
          // Load company logo
          fetch('/api/logo')
            .then(response => response.json())
            .then(data => {
              if (data.logo && data.logo.data) {
                const logoImg = document.getElementById('company-logo');
                if (logoImg) {
                  logoImg.src = data.logo.data;
                }
              }
            })
            .catch(error => {
            });
        </script>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
  };
  const sendInvoiceEmail = async (invoice: LoanInvoice) => {
    try {
      await apiRequest(
        `/api/loan-invoices/${invoice.id}/send-email`,
        "POST",
        {}
      );
      toast({
        title: "Success",
        description: "Invoice sent to customer email.",
      });
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to send invoice email.",
        variant: "destructive",
      });
    }
  };
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (
      !formData.customerId ||
      !formData.deviceDescription ||
      !formData.serviceDescription ||
      !formData.totalAmount
    ) {
      toast({
        title: "Error",
        description: "Please fill in all required fields.",
        variant: "destructive",
      });
      return;
    }
    const remainingAmount =
      parseFloat(formData.totalAmount) - parseFloat(formData.paidAmount);
    createInvoiceMutation.mutate({
      ...formData,
      totalAmount: parseFloat(formData.totalAmount),
      paidAmount: parseFloat(formData.paidAmount),
      remainingAmount,
    });
  };
  const handlePaymentSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!paymentData.amount || !selectedInvoice) {
      toast({
        title: "Error",
        description: "Please enter payment amount.",
        variant: "destructive",
      });
      return;
    }
    const paymentAmount = parseFloat(paymentData.amount);
    const remainingAmount = Number(selectedInvoice.remainingAmount || 0);
    if (paymentAmount > remainingAmount) {
      toast({
        title: "Error",
        description: "Payment amount cannot exceed remaining balance.",
        variant: "destructive",
      });
      return;
    }
    recordPaymentMutation.mutate({
      invoiceId: selectedInvoice.id,
      ...paymentData,
    });
  };
  const openPaymentDialog = (invoice: LoanInvoice) => {
    setSelectedInvoice(invoice);
    setPaymentData({
      amount: "",
      paymentMethod: "cash",
      notes: "",
    });
    setIsPaymentDialogOpen(true);
  };
  const openEditDialog = (invoice: LoanInvoice) => {
    setEditingInvoice(invoice);
    setIsEditDialogOpen(true);
  };
  const handleEditSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!editingInvoice) return;
    const formData = new FormData(e.target as HTMLFormElement);
    const updates = {
      deviceDescription: formData.get("deviceDescription") as string,
      serviceDescription: formData.get("serviceDescription") as string,
      totalAmount: parseFloat(formData.get("totalAmount") as string),
      dueDate: formData.get("dueDate") as string,
      notes: formData.get("notes") as string,
    };
    updateInvoiceMutation.mutate({
      id: editingInvoice.id,
      updates,
    });
  };
  const handleDelete = (invoice: LoanInvoice) => {
    if (confirm(`Are you sure you want to delete this invoice?`)) {
      deleteInvoiceMutation.mutate(invoice.id);
    }
  };

  if (isLoading) {
    return <div>Loading invoices...</div>;
  }
  const filteredInvoices = invoices.filter((invoice) => {
    const matchesSearch =
      invoice.customerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
      invoice.deviceDescription
        .toLowerCase()
        .includes(searchTerm.toLowerCase());
    const matchesStatus =
      statusFilter === "all" || invoice.status === statusFilter;
    return matchesSearch && matchesStatus;
  });
  return (
    <TooltipProvider>
      <div className="space-y-6">
        {/* Enhanced Header */}
        <div className="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-6 border border-purple-100">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent">
                Loan Invoice Management
              </h1>
              <p className="text-gray-600 mt-1">
                Manage payment requests and track outstanding balances with intelligent insights
              </p>
            </div>
            <div className="flex items-center space-x-2">
              <Badge variant="outline" className="flex items-center gap-1 bg-purple-50 border-purple-200">
                <Zap className="h-3 w-3 text-purple-600" />
                <span className="text-purple-700">Enhanced</span>
              </Badge>
              <Dialog
                open={isCombinedInvoiceDialogOpen}
                onOpenChange={setIsCombinedInvoiceDialogOpen}
              >
                <DialogTrigger asChild>
                  <Button variant="outline" className="hover:bg-blue-50 hover:border-blue-200">
                    <Plus className="h-4 w-4 mr-2" />
                    Combined Invoice
                  </Button>
                </DialogTrigger>
              </Dialog>
              <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
                <DialogTrigger asChild>
                  <Button className="bg-purple-600 hover:bg-purple-700">
                    <FileText className="h-4 w-4 mr-2" />
                    Create Invoice
                  </Button>
                </DialogTrigger>
              </Dialog>
            </div>
          </div>
          
          {/* Quick Stats Bar */}
          <div className="flex items-center justify-between text-sm text-gray-600">
            <div className="flex items-center space-x-4">
              <span className="flex items-center gap-1">
                <div className="w-2 h-2 rounded-full bg-purple-500"></div>
                {invoices.length} Total Invoices
              </span>
              <span className="flex items-center gap-1">
                <div className="w-2 h-2 rounded-full bg-red-500"></div>
                {invoices.filter(inv => {
                  const dueDate = new Date(inv.dueDate);
                  const today = new Date();
                  return dueDate < today && parseFloat(inv.remainingAmount?.toString() || "0") > 0;
                }).length} Overdue
              </span>
              <span className="flex items-center gap-1">
                <div className="w-2 h-2 rounded-full bg-green-500"></div>
                {invoices.filter(inv => parseFloat(inv.remainingAmount?.toString() || "0") === 0).length} Paid
              </span>
            </div>
            <div className="text-xs">
              Last updated: {new Date().toLocaleTimeString()}
            </div>
          </div>
        </div>

        {/* Notifications */}
        {notifications.length > 0 && (
          <div className="space-y-2">
            {notifications.map((notification) => (
              <Alert key={notification.id} className={`border-l-4 ${
                notification.type === 'success' ? 'border-green-500 bg-green-50' :
                notification.type === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                notification.type === 'error' ? 'border-red-500 bg-red-50' :
                'border-blue-500 bg-blue-50'
              }`}>
                <AlertDescription className="flex items-center justify-between">
                  <span>{notification.message}</span>
                  <span className="text-xs text-gray-500">
                    {notification.timestamp.toLocaleTimeString()}
                  </span>
                </AlertDescription>
              </Alert>
            ))}
          </div>
        )}

        {/* Enhanced Statistics Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <Card className="hover:shadow-md transition-shadow">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">
                Total Invoices
              </CardTitle>
              <FileText className="h-4 w-4 text-purple-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-purple-600">
                {calculateInvoiceStats().totalInvoices}
              </div>
              <p className="text-xs text-muted-foreground">
                All time invoices
              </p>
              {showInsights && calculateInvoiceStats().totalInvoices > 0 && (
                <div className="mt-2 text-xs text-purple-600 bg-purple-50 p-2 rounded">
                  <Activity className="h-3 w-3 inline mr-1" />
                  Active invoice tracking
                </div>
              )}
            </CardContent>
          </Card>

          <Card className="hover:shadow-md transition-shadow">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Total Amount</CardTitle>
              <DollarSign className="h-4 w-4 text-blue-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-blue-600">
                {formatCurrency(calculateInvoiceStats().totalAmount)}
              </div>
              <p className="text-xs text-muted-foreground">
                All invoices combined
              </p>
              {showInsights && calculateInvoiceStats().totalAmount > 0 && (
                <div className="mt-2 text-xs text-blue-600 bg-blue-50 p-2 rounded">
                  <TrendingUp className="h-3 w-3 inline mr-1" />
                  Revenue potential
                </div>
              )}
            </CardContent>
          </Card>

          <Card className="hover:shadow-md transition-shadow">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">Outstanding</CardTitle>
              <AlertTriangle className="h-4 w-4 text-red-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-red-600">
                {formatCurrency(calculateInvoiceStats().totalRemaining)}
              </div>
              <p className="text-xs text-muted-foreground">
                {calculateInvoiceStats().overdueInvoices} overdue invoices
              </p>
              {showInsights && calculateInvoiceStats().totalRemaining > 0 && (
                <div className="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">
                  <Clock className="h-3 w-3 inline mr-1" />
                  Requires attention
                </div>
              )}
            </CardContent>
          </Card>

          <Card className="hover:shadow-md transition-shadow">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
              <CardTitle className="text-sm font-medium">
                Collection Rate
              </CardTitle>
              <Target className="h-4 w-4 text-green-600" />
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-green-600">
                {calculateInvoiceStats().collectionRate.toFixed(1)}%
              </div>
              <p className="text-xs text-muted-foreground">
                Payment success rate
              </p>
              {showInsights && calculateInvoiceStats().collectionRate > 80 && (
                <div className="mt-2 text-xs text-green-600 bg-green-50 p-2 rounded">
                  <CheckCircle className="h-3 w-3 inline mr-1" />
                  Excellent collection rate
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Enhanced Controls and Filters */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="flex items-center space-x-2">
                <Filter className="h-5 w-5" />
                <span>Controls & Filters</span>
              </CardTitle>
              <div className="flex items-center space-x-2">
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setShowInsights(!showInsights)}
                      className={showInsights ? 'bg-purple-50 border-purple-200 text-purple-700' : ''}
                    >
                      {showInsights ? <Eye className="h-4 w-4 mr-2" /> : <EyeOff className="h-4 w-4 mr-2" />}
                      Insights
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>Toggle smart insights and recommendations</p>
                  </TooltipContent>
                </Tooltip>
                
                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setCompactView(!compactView)}
                      className={compactView ? 'bg-blue-50 border-blue-200 text-blue-700' : ''}
                    >
                      <Settings className="h-4 w-4 mr-2" />
                      {compactView ? 'Compact' : 'Normal'}
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>Toggle compact view mode</p>
                  </TooltipContent>
                </Tooltip>

                <Tooltip>
                  <TooltipTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setAutoRefresh(!autoRefresh)}
                      className={autoRefresh ? 'bg-green-50 border-green-200 text-green-700' : ''}
                    >
                      <RefreshCw className={`h-4 w-4 mr-2 ${autoRefresh ? 'animate-spin' : ''}`} />
                      Auto-refresh
                    </Button>
                  </TooltipTrigger>
                  <TooltipContent>
                    <p>Enable automatic data refresh</p>
                  </TooltipContent>
                </Tooltip>
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
              <div>
                <label className="text-sm font-medium text-gray-700">
                  Search
                </label>
                <div className="relative mt-1">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                  <Input
                    placeholder="Search invoices..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>

              <div>
                <label className="text-sm font-medium text-gray-700">
                  Status
                </label>
                <Select value={statusFilter} onValueChange={setStatusFilter}>
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Status</SelectItem>
                    <SelectItem value="pending">Pending</SelectItem>
                    <SelectItem value="paid">Paid</SelectItem>
                    <SelectItem value="overdue">Overdue</SelectItem>
                    <SelectItem value="cancelled">Cancelled</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <label className="text-sm font-medium text-gray-700">
                  Sort By
                </label>
                <Select value={sortBy} onValueChange={(value: any) => setSortBy(value)}>
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="date">Date</SelectItem>
                    <SelectItem value="amount">Amount</SelectItem>
                    <SelectItem value="status">Status</SelectItem>
                    <SelectItem value="customer">Customer</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="flex items-end space-x-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
                >
                  {sortOrder === 'asc' ? <SortAsc className="h-4 w-4" /> : <SortDesc className="h-4 w-4" />}
                </Button>
                <Button
                  variant="outline"
                  onClick={() => {
                    setSearchTerm("");
                    setStatusFilter("all");
                    setSortBy("date");
                    setSortOrder("desc");
                    addNotification('info', 'Filters cleared');
                  }}
                >
                  Clear All
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Performance Insights Section */}
        {showInsights && (
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-100">
            <div className="flex items-center gap-2 mb-4">
              <Lightbulb className="h-5 w-5 text-blue-600" />
              <h3 className="text-lg font-semibold text-blue-800">
                Invoice Insights
              </h3>
            </div>
            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
              {calculateInvoiceStats().overdueInvoices > 0 && (
                <div className="bg-white p-4 rounded-lg border border-red-200">
                  <div className="flex items-center gap-2 mb-2">
                    <AlertTriangle className="h-4 w-4 text-red-600" />
                    <span className="text-sm font-medium text-red-800">Overdue Invoices</span>
                  </div>
                  <p className="text-xs text-red-700">
                    {calculateInvoiceStats().overdueInvoices} invoices past due date
                  </p>
                  <div className="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">
                    <Clock className="h-3 w-3 inline mr-1" />
                    Immediate action required
                  </div>
                </div>
              )}
              
              {calculateInvoiceStats().collectionRate > 80 && (
                <div className="bg-white p-4 rounded-lg border border-green-200">
                  <div className="flex items-center gap-2 mb-2">
                    <CheckCircle className="h-4 w-4 text-green-600" />
                    <span className="text-sm font-medium text-green-800">High Collection Rate</span>
                  </div>
                  <p className="text-xs text-green-700">
                    {calculateInvoiceStats().collectionRate.toFixed(1)}% successful collections
                  </p>
                  <div className="mt-2 text-xs text-green-600 bg-green-50 p-2 rounded">
                    <TrendingUp className="h-3 w-3 inline mr-1" />
                    Excellent performance
                  </div>
                </div>
              )}
              
              {calculateInvoiceStats().totalRemaining > 0 && (
                <div className="bg-white p-4 rounded-lg border border-orange-200">
                  <div className="flex items-center gap-2 mb-2">
                    <DollarSign className="h-4 w-4 text-orange-600" />
                    <span className="text-sm font-medium text-orange-800">Outstanding Balance</span>
                  </div>
                  <p className="text-xs text-orange-700">
                    {formatCurrency(calculateInvoiceStats().totalRemaining)} in outstanding amounts
                  </p>
                  <div className="mt-2 text-xs text-orange-600 bg-orange-50 p-2 rounded">
                    <Target className="h-3 w-3 inline mr-1" />
                    Focus on collections
                  </div>
                </div>
              )}
              
              {calculateInvoiceStats().paidInvoices > 0 && (
                <div className="bg-white p-4 rounded-lg border border-teal-200">
                  <div className="flex items-center gap-2 mb-2">
                    <CheckSquare className="h-4 w-4 text-teal-600" />
                    <span className="text-sm font-medium text-teal-800">Completed Payments</span>
                  </div>
                  <p className="text-xs text-teal-700">
                    {calculateInvoiceStats().paidInvoices} invoices fully paid
                  </p>
                  <div className="mt-2 text-xs text-teal-600 bg-teal-50 p-2 rounded">
                    <CheckCircle className="h-3 w-3 inline mr-1" />
                    Successful collections
                  </div>
                </div>
              )}
              
              {calculateInvoiceStats().totalInvoices > 10 && (
                <div className="bg-white p-4 rounded-lg border border-purple-200">
                  <div className="flex items-center gap-2 mb-2">
                    <BarChart3 className="h-4 w-4 text-purple-600" />
                    <span className="text-sm font-medium text-purple-800">Invoice Volume</span>
                  </div>
                  <p className="text-xs text-purple-700">
                    {calculateInvoiceStats().totalInvoices} total invoices managed
                  </p>
                  <div className="mt-2 text-xs text-purple-600 bg-purple-50 p-2 rounded">
                    <Activity className="h-3 w-3 inline mr-1" />
                    Active business operations
                  </div>
                </div>
              )}
              
              {calculateInvoiceStats().totalAmount > 10000 && (
                <div className="bg-white p-4 rounded-lg border border-indigo-200">
                  <div className="flex items-center gap-2 mb-2">
                    <TrendingUp className="h-4 w-4 text-indigo-600" />
                    <span className="text-sm font-medium text-indigo-800">Revenue Potential</span>
                  </div>
                  <p className="text-xs text-indigo-700">
                    {formatCurrency(calculateInvoiceStats().totalAmount)} total invoice value
                  </p>
                  <div className="mt-2 text-xs text-indigo-600 bg-indigo-50 p-2 rounded">
                    <DollarSign className="h-3 w-3 inline mr-1" />
                    Strong revenue stream
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        <DialogContent className="max-w-md">
              <DialogHeader>
                <DialogTitle>Create Loan Invoice</DialogTitle>
              </DialogHeader>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <Label htmlFor="customerId">Customer</Label>
                  <Select
                    value={formData.customerId}
                    onValueChange={(value) =>
                      setFormData((prev) => ({ ...prev, customerId: value }))
                    }
                    disabled={customersLoading}
                  >
                    <SelectTrigger>
                      <SelectValue
                        placeholder={
                          customersLoading
                            ? "Loading customers..."
                            : "Select customer"
                        }
                      />
                    </SelectTrigger>
                    <SelectContent>
                      {customersLoading ? (
                        <SelectItem value="" disabled>
                          Loading customers...
                        </SelectItem>
                      ) : customers.length === 0 ? (
                        <SelectItem value="" disabled>
                          No customers found
                        </SelectItem>
                      ) : (
                        customers.map((customer: any) => (
                          <SelectItem key={customer.id} value={customer.id}>
                            {customer.name} - {customer.phone}
                          </SelectItem>
                        ))
                      )}
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label htmlFor="deviceDescription">Device Description</Label>
                  <Input
                    id="deviceDescription"
                    value={formData.deviceDescription}
                    onChange={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        deviceDescription: e.target.value,
                      }))
                    }
                    placeholder="e.g., iPhone 13 Pro"
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="serviceDescription">
                    Service Description
                  </Label>
                  <Input
                    id="serviceDescription"
                    value={formData.serviceDescription}
                    onChange={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        serviceDescription: e.target.value,
                      }))
                    }
                    placeholder="e.g., Screen replacement"
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="totalAmount">Total Amount</Label>
                  <Input
                    id="totalAmount"
                    type="number"
                    step="0.01"
                    value={formData.totalAmount}
                    onChange={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        totalAmount: e.target.value,
                      }))
                    }
                    placeholder="0.00"
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="paidAmount">Paid Amount</Label>
                  <Input
                    id="paidAmount"
                    type="number"
                    step="0.01"
                    value={formData.paidAmount}
                    onChange={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        paidAmount: e.target.value,
                      }))
                    }
                    placeholder="0.00"
                  />
                </div>
                <div>
                  <Label htmlFor="dueDate">Due Date</Label>
                  <Input
                    id="dueDate"
                    type="date"
                    value={formData.dueDate}
                    onChange={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        dueDate: e.target.value,
                      }))
                    }
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="notes">Notes</Label>
                  <Input
                    id="notes"
                    value={formData.notes}
                    onChange={(e) =>
                      setFormData((prev) => ({
                        ...prev,
                        notes: e.target.value,
                      }))
                    }
                    placeholder="Additional notes"
                  />
                </div>
                <Button
                  type="submit"
                  className="w-full"
                  disabled={createInvoiceMutation.isPending}
                >
                  {createInvoiceMutation.isPending
                    ? "Creating..."
                    : "Create Invoice"}
                </Button>
              </form>
            </DialogContent>
          </Dialog>
        </div>
      </div>

      {/* Invoices List */}
      <Card>
        <CardContent className="p-0">
          <div className="space-y-4">
            {filteredInvoices.length === 0 ? (
              <div className="p-8 text-center">
                <FileText className="mx-auto h-12 w-12 text-gray-300 mb-4" />
                <p className="text-gray-500">No invoices found</p>
              </div>
            ) : (
              filteredInvoices.map((invoice) => (
                <div key={invoice.id} className="p-6 border-b last:border-b-0">
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <h3 className="font-semibold text-lg">
                          {invoice.customerName}
                        </h3>
                        <Badge className={getStatusColor(invoice.status)}>
                          {invoice.status}
                        </Badge>
                      </div>
                      <p className="text-gray-600 mb-1">
                        {(() => {
                          const isCombinedInvoice =
                            invoice.notes &&
                            invoice.notes.startsWith("COMBINED_INVOICE_ITEMS:");
                          if (isCombinedInvoice && invoice.notes) {
                            try {
                              const itemsJson = invoice.notes.replace(
                                "COMBINED_INVOICE_ITEMS:",
                                ""
                              );
                              const items = JSON.parse(itemsJson);
                              const itemCount = items.length;
                              const serviceCount = items.filter(
                                (item: any) => item.type === "service"
                              ).length;
                              const salesCount = items.filter(
                                (item: any) => item.type === "sales"
                              ).length;
                              // Show first few item descriptions
                              const descriptions = items
                                .slice(0, 3)
                                .map((item: any) => item.description || "N/A")
                                .join(", ");
                              const moreText =
                                items.length > 3
                                  ? ` and ${items.length - 3} more`
                                  : "";
                              return `Combined Invoice: ${descriptions}${moreText}`;
                            } catch (error) {
                              return `${invoice.deviceDescription} - ${invoice.serviceDescription}`;
                            }
                          } else {
                            return `${invoice.deviceDescription} - ${invoice.serviceDescription}`;
                          }
                        })()}
                      </p>
                      <div className="flex items-center gap-4 text-sm text-gray-500">
                        <span>
                          Due: {format(parseISO(invoice.dueDate), "PPP")}
                        </span>
                        <span>
                          Created: {format(parseISO(invoice.createdAt), "PPP")}
                        </span>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-lg font-semibold">
                        {formatCurrency(invoice.totalAmount || 0)}
                      </div>
                      <div className="text-sm text-gray-500">
                        Remaining:{" "}
                        {formatCurrency(invoice.remainingAmount || 0)}
                      </div>
                    </div>
                    <div className="flex gap-2 ml-4">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => printInvoice(invoice)}
                      >
                        <Printer className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => sendInvoiceEmail(invoice)}
                      >
                        <Send className="h-4 w-4" />
                      </Button>
                      {(Number(invoice.remainingAmount) || 0) > 0 && (
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => openPaymentDialog(invoice)}
                        >
                          <CreditCard className="h-4 w-4" />
                        </Button>
                      )}
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => openEditDialog(invoice)}
                      >
                        <FileText className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleDelete(invoice)}
                        className="text-red-600 hover:text-red-700"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </CardContent>
      </Card>
      {/* Combined Invoice Dialog */}
      <Dialog
        open={isCombinedInvoiceDialogOpen}
        onOpenChange={setIsCombinedInvoiceDialogOpen}
      >
        <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Create Combined Loan Invoice</DialogTitle>
          </DialogHeader>
          <form onSubmit={handleCombinedInvoiceSubmit} className="space-y-6">
            <div>
              <Label htmlFor="combinedCustomerId">Customer</Label>
              <Select
                value={selectedCustomer}
                onValueChange={handleCustomerChange}
                disabled={customersLoading}
              >
                <SelectTrigger>
                  <SelectValue
                    placeholder={
                      customersLoading
                        ? "Loading customers..."
                        : "Select customer"
                    }
                  />
                </SelectTrigger>
                <SelectContent>
                  {customersLoading ? (
                    <SelectItem value="" disabled>
                      Loading customers...
                    </SelectItem>
                  ) : customers.length === 0 ? (
                    <SelectItem value="" disabled>
                      No customers found
                    </SelectItem>
                  ) : (
                    customers.map((customer: any) => (
                      <SelectItem key={customer.id} value={customer.id}>
                        {customer.name} - {customer.phone}
                      </SelectItem>
                    ))
                  )}
                </SelectContent>
              </Select>
            </div>
            {selectedCustomer && (
              <>
                <div>
                  <Label>Outstanding Amounts</Label>
                  <div className="mt-2 space-y-3">
                    {combinedInvoiceData.selectedItems.length === 0 ? (
                      <div className="space-y-3">
                        <p className="text-sm text-gray-500">
                          No outstanding amounts found for this customer.
                        </p>
                        <p className="text-sm text-gray-400">
                          Debug info: Services: {outstandingServices.length},
                          Sales: {outstandingSales.length}
                        </p>
                      </div>
                    ) : (
                      combinedInvoiceData.selectedItems.map((item) => (
                        <div
                          key={item.id}
                          className="flex items-center space-x-3 p-3 border rounded-lg"
                        >
                          <Checkbox
                            checked={item.selected}
                            onCheckedChange={(checked) =>
                              handleItemSelection(item.id, checked as boolean)
                            }
                          />
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              {item.type === "service" ? (
                                <Wrench className="h-4 w-4 text-blue-500" />
                              ) : (
                                <ShoppingCart className="h-4 w-4 text-green-500" />
                              )}
                              <span className="font-medium">
                                {item.description}
                              </span>
                              <Badge variant="outline">
                                {item.type === "service" ? "Service" : "Sales"}
                              </Badge>
                            </div>
                            <p className="text-sm text-gray-500">
                              {new Date(item.date).toLocaleDateString()}
                            </p>
                          </div>
                          <div className="text-right">
                            <p className="font-semibold">
                              {formatCurrency(item.amount)}
                            </p>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
                {combinedInvoiceData.selectedItems.some(
                  (item) => item.selected
                ) && (
                  <div className="p-4 bg-blue-50 rounded-lg">
                    <div className="flex justify-between items-center">
                      <span className="font-medium">Total Amount:</span>
                      <span className="text-xl font-bold text-blue-600">
                        {formatCurrency(
                          combinedInvoiceData.selectedItems
                            .filter((item) => item.selected)
                            .reduce((sum, item) => sum + Number(item.amount), 0)
                        )}
                      </span>
                    </div>
                  </div>
                )}
                <div>
                  <Label htmlFor="combinedDueDate">Due Date</Label>
                  <Input
                    id="combinedDueDate"
                    type="date"
                    value={combinedInvoiceData.dueDate}
                    onChange={(e) =>
                      setCombinedInvoiceData((prev) => ({
                        ...prev,
                        dueDate: e.target.value,
                      }))
                    }
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="combinedNotes">Notes</Label>
                  <Input
                    id="combinedNotes"
                    value={combinedInvoiceData.notes}
                    onChange={(e) =>
                      setCombinedInvoiceData((prev) => ({
                        ...prev,
                        notes: e.target.value,
                      }))
                    }
                    placeholder="Invoice notes (optional)"
                  />
                </div>
              </>
            )}
            <Button
              type="submit"
              className="w-full"
              disabled={
                createCombinedInvoiceMutation.isPending || !selectedCustomer
              }
            >
              {createCombinedInvoiceMutation.isPending
                ? "Creating..."
                : "Create Combined Invoice"}
            </Button>
          </form>
        </DialogContent>
      </Dialog>
      {/* Payment Dialog */}
      <Dialog open={isPaymentDialogOpen} onOpenChange={setIsPaymentDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Record Payment</DialogTitle>
          </DialogHeader>
          {selectedInvoice && (
            <div className="mb-4 p-4 bg-gray-50 rounded-lg">
              <h3 className="font-medium">{selectedInvoice.customerName}</h3>
              <p className="text-sm text-gray-600">
                {selectedInvoice.deviceDescription}
              </p>
              <div className="mt-2 text-sm">
                <span className="font-medium">Remaining Balance: </span>
                <span className="text-red-600">
                  {formatCurrency(selectedInvoice.remainingAmount || 0)}
                </span>
              </div>
            </div>
          )}
          <form onSubmit={handlePaymentSubmit} className="space-y-4">
            <div>
              <Label htmlFor="amount">Payment Amount</Label>
              <Input
                id="amount"
                type="number"
                step="0.01"
                value={paymentData.amount}
                onChange={(e) =>
                  setPaymentData((prev) => ({
                    ...prev,
                    amount: e.target.value,
                  }))
                }
                placeholder="0.00"
                required
              />
            </div>
            <div>
              <Label htmlFor="paymentMethod">Payment Method</Label>
              <Select
                value={paymentData.paymentMethod}
                onValueChange={(value) =>
                  setPaymentData((prev) => ({ ...prev, paymentMethod: value }))
                }
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="cash">Cash</SelectItem>
                  <SelectItem value="card">Card</SelectItem>
                  <SelectItem value="bank_transfer">Bank Transfer</SelectItem>
                  <SelectItem value="mobile_money">Mobile Money</SelectItem>
                  <SelectItem value="other">Other</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div>
              <Label htmlFor="paymentNotes">Notes</Label>
              <Input
                id="paymentNotes"
                value={paymentData.notes}
                onChange={(e) =>
                  setPaymentData((prev) => ({ ...prev, notes: e.target.value }))
                }
                placeholder="Payment notes (optional)"
              />
            </div>
            <Button
              type="submit"
              className="w-full"
              disabled={recordPaymentMutation.isPending}
            >
              {recordPaymentMutation.isPending
                ? "Recording..."
                : "Record Payment"}
            </Button>
          </form>
        </DialogContent>
      </Dialog>
      {/* Edit Invoice Dialog */}
      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Edit Loan Invoice</DialogTitle>
          </DialogHeader>
          {editingInvoice && (
            <form onSubmit={handleEditSubmit} className="space-y-4">
              <div>
                <Label htmlFor="editDeviceDescription">
                  Device Description
                </Label>
                <Input
                  id="editDeviceDescription"
                  name="deviceDescription"
                  defaultValue={editingInvoice.deviceDescription}
                  required
                />
              </div>
              <div>
                <Label htmlFor="editServiceDescription">
                  Service Description
                </Label>
                <Input
                  id="editServiceDescription"
                  name="serviceDescription"
                  defaultValue={editingInvoice.serviceDescription}
                  required
                />
              </div>
              <div>
                <Label htmlFor="editTotalAmount">Total Amount</Label>
                <Input
                  id="editTotalAmount"
                  name="totalAmount"
                  type="number"
                  step="0.01"
                  defaultValue={Number(editingInvoice.totalAmount) || 0}
                  required
                />
              </div>
              <div>
                <Label htmlFor="editDueDate">Due Date</Label>
                <Input
                  id="editDueDate"
                  name="dueDate"
                  type="date"
                  defaultValue={editingInvoice.dueDate.split("T")[0]}
                  required
                />
              </div>
              <div>
                <Label htmlFor="editNotes">Notes</Label>
                <Input
                  id="editNotes"
                  name="notes"
                  defaultValue={editingInvoice.notes || ""}
                  placeholder="Optional notes"
                />
              </div>
              <Button
                type="submit"
                className="w-full"
                disabled={updateInvoiceMutation.isPending}
              >
                {updateInvoiceMutation.isPending
                  ? "Updating..."
                  : "Update Invoice"}
              </Button>
            </form>
          )}
        </DialogContent>
      </Dialog>
    </div>
  </TooltipProvider>
  );
}
